<div id="<?php echo $selector; ?>" class="gallery gallery-columns-<?php echo $columns ?> gallery-size-<?php echo $size ?>"><?php foreach ($attachments as $id => $attachment): ?><?php $image_data = wp_get_attachment_image_src($id, 'full'); $link = ''; if( count($image_data) ) { $link = current($image_data); } ?><div class="wp-caption gallery-item" id="attachment_<?php echo $id; ?>"><?php if($link): ?><a rel="group-<?php echo $pid; ?>" href="<?php echo $link; ?>"><?php endif; ?><?php echo wp_get_attachment_image($id, $size); ?><?php if( trim($attachment->post_excerpt) ): ?><div class="caption wp-caption-text"><?php echo wptexturize($attachment->post_excerpt); ?></div><?php endif; ?><?php if($link): ?></a><?php endif; ?></div><?php endforeach; ?></div>